<div class="grid-container">
  <div class="left-toolbox">
    <app-controls-panel></app-controls-panel>
  </div>

  <div class="main-content">
    <!-- Path Info Display -->
    @if (pathLength()) {
      <div class="path-info">
        <div class="path-length">
          Path Length: {{ pathLength() | number:'1.1-1' }} units
        </div>
        @if (path(); as pathData) {
          <div class="path-points">
            {{ pathData.length }} points
          </div>
        }
      </div>
    }

    @if (grid(); as gridData) {
      <div class="grid-canvas"
           [ngClass]="cursorClass()"
           (mouseup)="onMouseUp($event)"
           (mouseleave)="onMouseUp($event)">
        <div class="grid-wrapper">
          <!-- X-axis labels at top -->
          <div class="x-axis">
            <div class="axis-corner"></div>
            @for (cell of gridData[0]; track $index; let x = $index) {
              <div class="axis-label">{{ x }}</div>
            }
          </div>

          <div class="grid-with-y-axis">
            <!-- Y-axis labels on left -->
            <div class="y-axis">
              @for (row of gridData; track $index; let y = $index) {
                <div class="axis-label">{{ y }}</div>
              }
            </div>

            <div class="table-container">
              <table #gridTable>
                <tbody>
                  @for (row of gridData; track $index; let y = $index) {
                    <tr>
                      @for (cell of row; track $index; let x = $index) {
                        <td
                          [ngClass]="getCellClass(cell, y, x)"
                          (mousedown)="onCellClick(y, x, $event)"
                          (mouseenter)="onCellMouseEnter(y, x, $event)"
                          (mousemove)="onCellMouseMove(y, x, $event)"
                          (mouseleave)="onCellMouseLeave()"
                          (contextmenu)="$event.preventDefault()">
                          {{ getWaypointNumber(y, x) }}
                        </td>
                      }
                    </tr>
                  }
                </tbody>
              </table>

              <!-- SVG overlay for paths -->
              <svg
                class="path-overlay"
                [attr.width]="svgWidth()"
                [attr.height]="svgHeight()">

                <!-- Camera coverage areas -->
                @for (camera of cameraPositions(); track $index) {
                  <circle
                    [attr.cx]="getCameraX(camera)"
                    [attr.cy]="getCameraY(camera)"
                    [attr.r]="getCameraRangeRadius(cameraRange())"
                    class="camera-range"
                    fill="rgba(0, 150, 255, 0.1)"
                    stroke="rgba(0, 150, 255, 0.3)"
                    stroke-width="1"
                  />
                }

                @for (segment of pathSegments(); track $index) {
                  <line
                    [attr.x1]="segment.x1"
                    [attr.y1]="segment.y1"
                    [attr.x2]="segment.x2"
                    [attr.y2]="segment.y2"
                    [attr.class]="segment.isReturnPath ? 'return-path-line' : 'path-line'"
                    stroke-width="3"
                  />
                }
              </svg>

              <!-- Draggable turning points -->
              @for (point of turningPoints(); track point.index) {
                <div
                  class="turning-point"
                  [style.left.px]="getTurningPointX(point.point)"
                  [style.top.px]="getTurningPointY(point.point)"
                  [attr.data-index]="point.index"
                  (mousedown)="startDragTurningPoint($event, point.index)"
                  (dragstart)="$event.preventDefault()">
                </div>
              }

              <!-- Camera positions -->
              @for (camera of cameraPositions(); track $index) {
                <div
                  class="camera-position"
                  [style.left.px]="getCameraX(camera)"
                  [style.top.px]="getCameraY(camera)"
                  [style.background]="camera.y > 55 ? 'red' : (camera.x > 75 ? 'orange' : 'transparent')"
                  [title]="'Camera ' + ($index + 1) + ' at (' + camera.x + ', ' + camera.y + ')'">
                  <span class="camera-icon">ðŸ“·</span>
                  <span class="camera-number">{{ $index + 1 }}</span>
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    } @else {
      <div>Loading grid...</div>
    }

    <!-- Mouse coordinate popover -->
    @if (showPopover() && hoveredCell(); as cell) {
      <div class="cell-popover"
           [style.left.px]="popoverPosition().x"
           [style.top.px]="popoverPosition().y">
        x: {{ cell.x }}, y: {{ cell.y }}
      </div>
    }
  </div>
</div>
